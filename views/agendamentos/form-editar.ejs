<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="bi bi-pencil"></i> Editar Agendamento</h3>
    <a href="/agenda" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>
</div>

<% const ag = agendamento || {}; %>

<div class="card">
    <div class="card-body">
        <form action="/agendamentos/<%= ag.id %>/editar" method="POST">
            <% if (redirectTo) { %>
                <input type="hidden" name="redirect_to" value="<%= redirectTo %>">
            <% } %>

            <div class="row g-3">
                <div class="col-md-6">
                    <label for="paciente_id" class="form-label">Paciente *</label>
                    <select class="form-select" id="paciente_id" name="paciente_id" required>
                        <option value="">Selecione um paciente...</option>
                        <% if (typeof pacientes !== 'undefined' && pacientes && pacientes.length) { %>
                            <% pacientes.forEach(p => { %>
                                <option value="<%= p.id %>" <%= String(ag.paciente_id) === String(p.id) ? 'selected' : '' %>><%= p.nome %> (CPF: <%= p.cpf %>)</option>
                            <% }) %>
                        <% } %>
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="profissional_id" class="form-label">Profissional *</label>
                    <select class="form-select" id="profissional_id" name="profissional_id" required>
                        <option value="">Selecione um profissional...</option>
                        <% if (typeof profissionais !== 'undefined' && profissionais && profissionais.length) { %>
                            <% profissionais.forEach(pr => { %>
                                <option value="<%= pr.id %>" <%= String(ag.profissional_id) === String(pr.id) ? 'selected' : '' %>><%= pr.nome %></option>
                            <% }) %>
                        <% } %>
                    </select>
                </div>

                <div class="col-md-4">
                    <label for="data_hora" class="form-label">Data e Hora *</label>
                    <input type="datetime-local" class="form-control" id="data_hora" name="data_hora" value="<%= ag.data_hora_form || '' %>" required>
                </div>

                <div class="col-md-2">
                    <label for="duracao_minutos" class="form-label">Duração (min) *</label>
                    <input type="number" class="form-control" id="duracao_minutos" name="duracao_minutos" value="<%= ag.duracao_minutos || 30 %>" min="15" max="240" required>
                </div>

                <div class="col-md-6">
                    <label for="tipo_consulta" class="form-label">Tipo de Consulta *</label>
                    <select class="form-select" id="tipo_consulta" name="tipo_consulta" required>
                        <option value="">Selecione...</option>
                        <option value="avaliacao" <%= (ag.tipo_consulta === 'avaliacao') ? 'selected' : '' %>>Avaliação</option>
                        <option value="fisioterapia" <%= (ag.tipo_consulta === 'fisioterapia') ? 'selected' : '' %>>Fisioterapia</option>
                        <option value="osteopatia" <%= (ag.tipo_consulta === 'osteopatia') ? 'selected' : '' %>>Osteopatia</option>
                        <option value="pilates" <%= (ag.tipo_consulta === 'pilates') ? 'selected' : '' %>>Pilates</option>
                        <option value="reavaliacao" <%= (ag.tipo_consulta === 'reavaliacao') ? 'selected' : '' %>>Reavaliação</option>
                        <option value="alta" <%= (ag.tipo_consulta === 'alta') ? 'selected' : '' %>>Alta</option>
                    </select>
                </div>

                <div class="col-12">
                    <label for="observacoes" class="form-label">Observações</label>
                    <textarea class="form-control" id="observacoes" name="observacoes" rows="4" placeholder="Observações sobre o agendamento..."><%= ag.observacoes || '' %></textarea>
                </div>

                <div class="col-md-6">
                    <label for="valor" class="form-label">Valor da Consulta</label>
                    <div class="input-group">
                        <span class="input-group-text">R$</span>
                        <input type="number" class="form-control" id="valor" name="valor" step="0.01" min="0" value="<%= ag.valor != null ? ag.valor : '' %>">
                    </div>
                </div>

                <div class="col-md-6">
                    <label for="forma_pagamento" class="form-label">Forma de Pagamento</label>
                    <select class="form-select" id="forma_pagamento" name="forma_pagamento">
                        <option value="" <%= !ag.forma_pagamento ? 'selected' : '' %>>Selecione...</option>
                        <option value="dinheiro" <%= ag.forma_pagamento === 'dinheiro' ? 'selected' : '' %>>Dinheiro</option>
                        <option value="cartao" <%= ag.forma_pagamento === 'cartao' ? 'selected' : '' %>>Cartão</option>
                        <option value="pix" <%= ag.forma_pagamento === 'pix' ? 'selected' : '' %>>PIX</option>
                        <option value="boleto" <%= ag.forma_pagamento === 'boleto' ? 'selected' : '' %>>Boleto</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="status_pagamento" class="form-label">Status do Pagamento</label>
                    <select class="form-select" id="status_pagamento" name="status_pagamento">
                        <option value="" <%= !ag.status_pagamento ? 'selected' : '' %>>Selecione...</option>
                        <option value="pendente" <%= ag.status_pagamento === 'pendente' ? 'selected' : '' %>>Pendente</option>
                        <option value="pago" <%= ag.status_pagamento === 'pago' ? 'selected' : '' %>>Pago</option>
                        <option value="cancelado" <%= ag.status_pagamento === 'cancelado' ? 'selected' : '' %>>Cancelado</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="convenio" class="form-label">Convênio</label>
                    <select class="form-select" id="convenio" name="convenio">
                        <option value="" <%= !ag.convenio ? 'selected' : '' %>>Selecione...</option>
                        <option value="particular" <%= ag.convenio === 'particular' ? 'selected' : '' %>>Particular</option>
                        <option value="unimed" <%= ag.convenio === 'unimed' ? 'selected' : '' %>>Unimed</option>
                        <option value="amil" <%= ag.convenio === 'amil' ? 'selected' : '' %>>Amil</option>
                        <option value="bradesco" <%= ag.convenio === 'bradesco' ? 'selected' : '' %>>Bradesco Saúde</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="status" class="form-label">Status do Agendamento</label>
                    <select class="form-select" id="status" name="status">
                        <option value="agendado" <%= (ag.status || 'agendado') === 'agendado' ? 'selected' : '' %>>Agendado</option>
                        <option value="confirmado" <%= ag.status === 'confirmado' ? 'selected' : '' %>>Confirmado</option>
                        <option value="realizado" <%= ag.status === 'realizado' ? 'selected' : '' %>>Realizado</option>
                        <option value="cancelado" <%= ag.status === 'cancelado' ? 'selected' : '' %>>Cancelado</option>
                    </select>
                </div>

                <div class="col-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="enviar_lembrete" name="enviar_lembrete" <%= (ag.enviar_lembrete == null || String(ag.enviar_lembrete) === '1') ? 'checked' : '' %>>
                        <label class="form-check-label" for="enviar_lembrete">
                            Enviar lembrete automático por WhatsApp
                        </label>
                    </div>
                </div>

                <div class="col-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="confirmar_whatsapp" name="confirmar_whatsapp" <%= (ag.confirmar_whatsapp == null || String(ag.confirmar_whatsapp) === '1') ? 'checked' : '' %>>
                        <label class="form-check-label" for="confirmar_whatsapp">
                            Confirmar agendamento via WhatsApp
                        </label>
                    </div>
                </div>

                <% if (error) { %>
                    <div class="col-12">
                        <div class="alert alert-danger"><%= error %></div>
                    </div>
                <% } %>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between">
                        <a href="<%= redirectTo || '/agenda' %>" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Salvar
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
