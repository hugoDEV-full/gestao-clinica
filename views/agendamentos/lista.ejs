<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="bi bi-calendar-check"></i> Agendamentos</h3>
    <div class="btn-group">
        <button type="button" class="btn btn-primary" onclick="window.location.href='/agendamentos/novo'" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Cadastrar um novo agendamento (paciente, data/hora, profissional e tipo).">
            <i class="bi bi-plus-circle"></i> Novo Agendamento
        </button>
        <a href="/agendamentos/export?<%= new URLSearchParams({ status: (filtros && filtros.status) ? filtros.status : '', profissional_id: (filtros && filtros.profissional_id) ? filtros.profissional_id : '', periodo: (filtros && filtros.periodo) ? filtros.periodo : '', format: 'csv' }).toString() %>" class="btn btn-outline-secondary" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Exportar a lista atual de agendamentos.">
            <i class="bi bi-download"></i> Exportar
        </a>
    </div>
</div>

<!-- Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" action="/agendamentos">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status">
                        <option value="" <%= !(filtros && filtros.status) ? 'selected' : '' %>>Todos</option>
                        <option value="agendado" <%= (filtros && filtros.status === 'agendado') ? 'selected' : '' %>>Agendado</option>
                        <option value="confirmado" <%= (filtros && filtros.status === 'confirmado') ? 'selected' : '' %>>Confirmado</option>
                        <option value="realizado" <%= (filtros && filtros.status === 'realizado') ? 'selected' : '' %>>Realizado</option>
                        <option value="cancelado" <%= (filtros && filtros.status === 'cancelado') ? 'selected' : '' %>>Cancelado</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Profissional</label>
                    <select class="form-select" name="profissional_id">
                        <option value="" <%= !(filtros && filtros.profissional_id) ? 'selected' : '' %>>Todos</option>
                        <% if (typeof profissionais !== 'undefined' && profissionais && profissionais.length) { %>
                            <% profissionais.forEach(pr => { %>
                                <option value="<%= pr.id %>" <%= (filtros && String(filtros.profissional_id) === String(pr.id)) ? 'selected' : '' %>><%= pr.nome %></option>
                            <% }) %>
                        <% } %>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Período</label>
                    <select class="form-select" name="periodo">
                        <option value="" <%= !(filtros && filtros.periodo) ? 'selected' : '' %>>Todos</option>
                        <option value="hoje" <%= (filtros && filtros.periodo === 'hoje') ? 'selected' : '' %>>Hoje</option>
                        <option value="semana" <%= (filtros && filtros.periodo === 'semana') ? 'selected' : '' %>>Esta Semana</option>
                        <option value="mes" <%= (filtros && filtros.periodo === 'mes') ? 'selected' : '' %>>Este Mês</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-funnel"></i> Filtrar
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Lista de Agendamentos -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="bi bi-list-ul"></i> Agendamentos
        </h5>
    </div>
    <div class="card-body">
        <% if (agendamentos && agendamentos.length > 0) { %>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Data/Hora</th>
                        <th>Paciente</th>
                        <th>Profissional</th>
                        <th>Tipo</th>
                        <th>Duração</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <% agendamentos.forEach(a => { %>
                    <tr>
                        <td>
                            <div><%= moment(a.data_hora).format('DD/MM/YYYY') %></div>
                            <small class="text-muted"><%= moment(a.data_hora).format('HH:mm') %></small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                    <%= (a.paciente_nome || 'P').charAt(0).toUpperCase() %>
                                </div>
                                <div>
                                    <div class="fw-bold"><%= a.paciente_nome || 'Não informado' %></div>
                                    <small class="text-muted">CPF: <%= a.paciente_cpf || 'Não informado' %></small>
                                </div>
                            </div>
                        </td>
                        <td><%= a.profissional_nome || 'Não informado' %></td>
                        <td><span class="badge bg-primary"><%= a.tipo_consulta || 'Consulta' %></span></td>
                        <td><%= a.duracao_minutos || 30 %> min</td>
                        <td>
                            <% const st = (a.status || '').toLowerCase(); %>
                            <% const badge = st === 'confirmado' ? 'bg-success' : (st === 'cancelado' ? 'bg-danger' : (st === 'realizado' ? 'bg-secondary' : 'bg-warning')); %>
                            <span class="badge <%= badge %>"><%= a.status || 'agendado' %></span>
                        </td>
                        <td>
                            <div class="btn-group">
                                <a class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="Editar" href="/agendamentos/<%= a.id %>/editar?redirect_to=<%= encodeURIComponent('/agendamentos') %>">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="tooltip" data-bs-placement="top" title="Confirmar" data-action="ag-status" data-id="<%= a.id %>" data-status="confirmado">
                                    <i class="bi bi-check-circle"></i>
                                </button>
                                <a class="btn btn-sm btn-outline-warning" data-bs-toggle="tooltip" data-bs-placement="top" title="Remarcar" href="/agendamentos/<%= a.id %>/remarcar">
                                    <i class="bi bi-calendar-event"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" data-bs-placement="top" title="Cancelar" data-action="ag-cancelar" data-id="<%= a.id %>">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
        <% } else { %>
            <div class="text-center py-5 text-muted">
        		<i class="bi bi-calendar-x fs-1"></i>
        		<h5 class="mt-3">Nenhum agendamento encontrado</h5>
        		<p class="mb-0">Crie um novo agendamento para aparecer aqui.</p>
        		<a href="/agendamentos/novo" class="btn btn-primary mt-3"><i class="bi bi-plus-circle"></i> Novo Agendamento</a>
        	</div>
        <% } %>
    </div>
</div>

<script>
async function agStatus(id, status) {
    try {
        const ok = confirm('Confirmar alteração de status para ' + status + '?');
        if (!ok) return;
        const resp = await fetch('/agendamentos/' + id + '/status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
        });
        const data = await resp.json();
        if (data && data.success) return window.location.reload();
        alert((data && data.message) ? data.message : 'Erro ao atualizar status');
    } catch (e) {
        alert('Erro ao atualizar status');
    }
}

async function agCancelar(id) {
    try {
        const ok = confirm('Deseja cancelar este agendamento?');
        if (!ok) return;
        const resp = await fetch('/agendamentos/' + id + '/cancelar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ motivo: 'Cancelado pelo usuário' })
        });
        const data = await resp.json();
        if (data && data.success) return window.location.reload();
        alert((data && data.message) ? data.message : 'Erro ao cancelar');
    } catch (e) {
        alert('Erro ao cancelar');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-action="ag-status"]').forEach((btn) => {
        btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-id');
            const status = btn.getAttribute('data-status') || 'confirmado';
            agStatus(id, status);
        });
    });
    document.querySelectorAll('[data-action="ag-cancelar"]').forEach((btn) => {
        btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-id');
            agCancelar(id);
        });
    });
});
</script>
