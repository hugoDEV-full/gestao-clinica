<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="bi bi-gear"></i> Configurações</h3>
    <button type="button" class="btn btn-primary" onclick="salvarConfiguracoes()">
        <i class="bi bi-check-circle"></i> Salvar Alterações
    </button>
</div>

<!-- Abas de Configurações -->
<ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="geral-tab" data-bs-toggle="tab" data-bs-target="#geral" type="button" role="tab" aria-controls="geral" aria-selected="true" onclick="return window.__cfgTabClick ? window.__cfgTabClick(event, this) : true;">
            <i class="bi bi-house"></i> Geral
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="smtp-tab" data-bs-toggle="tab" data-bs-target="#smtp" type="button" role="tab" aria-controls="smtp" aria-selected="false" onclick="return window.__cfgTabClick ? window.__cfgTabClick(event, this) : true;">
            <i class="bi bi-envelope"></i> E-mail (SMTP)
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="whatsapp-tab" data-bs-toggle="tab" data-bs-target="#whatsapp" type="button" role="tab" aria-controls="whatsapp" aria-selected="false" onclick="return window.__cfgTabClick ? window.__cfgTabClick(event, this) : true;">
            <i class="bi bi-whatsapp"></i> WhatsApp
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="lembretes-tab" data-bs-toggle="tab" data-bs-target="#lembretes" type="button" role="tab" aria-controls="lembretes" aria-selected="false" onclick="return window.__cfgTabClick ? window.__cfgTabClick(event, this) : true;">
            <i class="bi bi-bell"></i> Lembretes
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="agenda-tab" data-bs-toggle="tab" data-bs-target="#agenda" type="button" role="tab" aria-controls="agenda" aria-selected="false" onclick="return window.__cfgTabClick ? window.__cfgTabClick(event, this) : true;">
            <i class="bi bi-calendar3"></i> Agenda
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="acesso-tab" data-bs-toggle="tab" data-bs-target="#acesso" type="button" role="tab" aria-controls="acesso" aria-selected="false" onclick="return window.__cfgTabClick ? window.__cfgTabClick(event, this) : true;">
            <i class="bi bi-shield-check"></i> Acesso/QR
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup" type="button" role="tab" aria-controls="backup" aria-selected="false" onclick="return window.__cfgTabClick ? window.__cfgTabClick(event, this) : true;">
            <i class="bi bi-cloud-download"></i> Backup
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="permissoes-tab" data-bs-toggle="tab" data-bs-target="#permissoes" type="button" role="tab" aria-controls="permissoes" aria-selected="false" onclick="return window.__cfgTabClick ? window.__cfgTabClick(event, this) : true;">
            <i class="bi bi-shield-lock"></i> Permissões
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab" aria-controls="logs" aria-selected="false" onclick="return window.__cfgTabClick ? window.__cfgTabClick(event, this) : true;">
            <i class="bi bi-terminal"></i> Logs
        </button>
    </li>
</ul>

<!-- Conteúdo das Abas -->
<div class="tab-content" id="configTabContent">
    <!-- Aba Geral -->
    <div class="tab-pane fade show active" id="geral" role="tabpanel" aria-labelledby="geral-tab">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-house"></i> Configurações Gerais
                </h5>
            </div>
            <div class="card-body">
                <div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Nome da Clínica *</label>
                            <input type="text" class="form-control" id="cfg_nome" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">CNPJ</label>
                            <input type="text" class="form-control" id="cfg_cnpj" placeholder="00.000.000/0000-00">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Telefone Principal *</label>
                            <input type="tel" class="form-control" id="cfg_telefone" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email Principal *</label>
                            <input type="email" class="form-control" id="cfg_email" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Endereço</label>
                            <input type="text" class="form-control" id="cfg_endereco" placeholder="Rua, número, complemento">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="cfg_cidade" placeholder="Brasília">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Estado</label>
                            <select class="form-select" id="cfg_estado">
                                <option value="">UF</option>
                                <option value="AC">AC</option>
                                <option value="AL">AL</option>
                                <option value="AP">AP</option>
                                <option value="AM">AM</option>
                                <option value="BA">BA</option>
                                <option value="CE">CE</option>
                                <option value="DF">DF</option>
                                <option value="ES">ES</option>
                                <option value="GO">GO</option>
                                <option value="MA">MA</option>
                                <option value="MT">MT</option>
                                <option value="MS">MS</option>
                                <option value="MG">MG</option>
                                <option value="PA">PA</option>
                                <option value="PB">PB</option>
                                <option value="PR">PR</option>
                                <option value="PE">PE</option>
                                <option value="PI">PI</option>
                                <option value="RJ">RJ</option>
                                <option value="RN">RN</option>
                                <option value="RS">RS</option>
                                <option value="RO">RO</option>
                                <option value="RR">RR</option>
                                <option value="SC">SC</option>
                                <option value="SP">SP</option>
                                <option value="SE">SE</option>
                                <option value="TO">TO</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">CEP</label>
                            <input type="text" class="form-control" id="cfg_cep" placeholder="00000-000">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Logo da Clínica</label>
                            <form action="/configuracoes/logo" method="POST" enctype="multipart/form-data">
                                <input type="file" class="form-control" name="logo" accept="image/*" required>
                                <div class="d-flex justify-content-end mt-2">
                                    <button type="submit" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-upload"></i> Enviar Logo
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_exibirLogo">
                                <label class="form-check-label" for="cfg_exibirLogo">
                                    Exibir logo nos relatórios
                                </label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_modoManutencao">
                                <label class="form-check-label" for="cfg_modoManutencao">
                                    Modo Manutenção (só administradores acessam)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Aba Permissões -->
    <div class="tab-pane fade" id="permissoes" role="tabpanel" aria-labelledby="permissoes-tab">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-lock"></i> Permissões por Perfil
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="mb-2">Financeiro</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cfg_perm_financeiro_medico_ver">
                            <label class="form-check-label" for="cfg_perm_financeiro_medico_ver">
                                Permitir que o perfil <strong>Médico</strong> acesse a página do Financeiro
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cfg_perm_financeiro_medico_lancar">
                            <label class="form-check-label" for="cfg_perm_financeiro_medico_lancar">
                                Permitir que o perfil <strong>Médico</strong> lance movimentações no Financeiro
                            </label>
                        </div>
                        <small class="form-text text-muted">Observação: Administrador sempre tem acesso total. Secretária pode lançar, mas não visualiza lista/resumo.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Aba SMTP -->
    <div class="tab-pane fade" id="smtp" role="tabpanel" aria-labelledby="smtp-tab">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-envelope"></i> Configurações de E-mail (SMTP)
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">URL Externa (APP_BASE_URL)</label>
                        <input type="text" class="form-control" id="cfg_appBaseUrl" placeholder="https://seu-ngrok.ngrok-free.dev">
                        <small class="form-text text-muted">Usada para gerar links nos e-mails (ex.: recuperação de senha).</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Servidor (Host)</label>
                        <input type="text" class="form-control" id="cfg_smtpHost" placeholder="smtp.gmail.com">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Porta</label>
                        <input type="number" class="form-control" id="cfg_smtpPort" placeholder="587" min="1" max="65535">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Secure (SSL)</label>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="cfg_smtpSecure">
                            <label class="form-check-label" for="cfg_smtpSecure">Usar SSL</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Usuário</label>
                        <input type="text" class="form-control" id="cfg_smtpUser" placeholder="seuemail@dominio.com">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Senha</label>
                        <input type="password" class="form-control" id="cfg_smtpPass" placeholder="senha / app password">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Remetente (From)</label>
                        <input type="text" class="form-control" id="cfg_smtpFrom" placeholder="Clinica <no-reply@dominio.com>">
                        <small class="form-text text-muted">Dica: no Gmail, use Senha de App (App Password).</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Aba WhatsApp -->
    <div class="tab-pane fade" id="whatsapp" role="tabpanel" aria-labelledby="whatsapp-tab">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-whatsapp"></i> Configurações do WhatsApp
                </h5>
            </div>
            <div class="card-body">
                <form>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Número WhatsApp *</label>
                            <input type="text" class="form-control" id="cfg_whatsappNumber" required>
                            <small class="form-text text-muted">Formato: 55DD9XXXXXXXXX</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <div class="form-control-plaintext">
                                <span class="badge bg-secondary" data-whatsapp-status>Carregando...</span>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_whatsappAutoConfirmar">
                                <label class="form-check-label" for="cfg_whatsappAutoConfirmar">
                                    Confirmar agendamentos automaticamente
                                </label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_whatsappEnviarLembretes">
                                <label class="form-check-label" for="cfg_whatsappEnviarLembretes">
                                    Enviar lembretes automáticos
                                </label>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Mensagem Padrão</label>
                            <textarea class="form-control" rows="4" id="cfg_whatsappMensagemPadrao"></textarea>
                        </div>
                        <div class="col-12">
                            <button type="button" class="btn btn-outline-warning" onclick="configWhatsappReconectar()">
                                <i class="bi bi-arrow-clockwise"></i> Reconectar WhatsApp
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="configWhatsappNovoQr()">
                                <i class="bi bi-qr-code"></i> Gerar Novo QR Code
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="configWhatsappTeste()">
                                <i class="bi bi-send"></i> Testar Envio
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Aba Acesso/QR -->
    <div class="tab-pane fade" id="acesso" role="tabpanel" aria-labelledby="acesso-tab">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-check"></i> Controle de Acesso e Ponto (QR)
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Modo do QR</label>
                        <select class="form-select" id="cfg_access_qr_mode" title="Define se o QR é permanente (crachá) ou dinâmico com expiração" data-bs-toggle="tooltip">
                            <option value="fixed">QR fixo (crachá)</option>
                            <option value="dynamic">QR dinâmico (expira)</option>
                        </select>
                        <small class="form-text text-muted">No modo fixo, o crachá é permanente. No dinâmico, o QR expira.</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Chave HMAC (ACCESS_HMAC_SECRET)</label>
                        <input type="text" class="form-control" id="cfg_access_hmac_secret" placeholder="defina uma chave forte" title="Usada para assinar o token do QR com segurança" data-bs-toggle="tooltip">
                        <small class="form-text text-muted">Obrigatória para assinatura do token QR. Guarde com segurança.</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">TTL QR (segundos)</label>
                        <input type="number" class="form-control" id="cfg_access_qr_ttl_sec" min="10" max="300" placeholder="30" title="Tempo de vida do QR dinâmico" data-bs-toggle="tooltip">
                        <small class="form-text text-muted">Tempo de vida do QR.</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Whitelist por device</label>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="cfg_access_device_whitelist_enabled" title="Se ativo, apenas devices cadastrados podem registrar ponto" data-bs-toggle="tooltip">
                            <label class="form-check-label" for="cfg_access_device_whitelist_enabled">Exigir device cadastrado</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cfg_access_device_whitelist_auto_add" title="Se ativo, o primeiro uso cadastra o device automaticamente" data-bs-toggle="tooltip">
                            <label class="form-check-label" for="cfg_access_device_whitelist_auto_add">Auto-cadastrar device</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Device ID (validade em dias)</label>
                        <input type="number" class="form-control" id="cfg_access_device_ttl_days" min="30" max="365" placeholder="180" title="Rotação do deviceId no navegador (30 a 365 dias)" data-bs-toggle="tooltip">
                        <small class="form-text text-muted">Rotação automática do identificador do dispositivo.</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Janela anti-duplicidade (minutos)</label>
                        <input type="number" class="form-control" id="cfg_access_ponto_dup_minutes" min="1" max="15" placeholder="3" title="Bloqueia ponto repetido do mesmo tipo dentro da janela" data-bs-toggle="tooltip">
                        <small class="form-text text-muted">Bloqueia ponto repetido do mesmo tipo.</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rate limit IP+Device (por minuto)</label>
                        <input type="number" class="form-control" id="cfg_access_rate_ip_limit" min="2" max="60" placeholder="10" title="Limite de tentativas por IP+Device na janela" data-bs-toggle="tooltip">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Janela IP+Device (segundos)</label>
                        <input type="number" class="form-control" id="cfg_access_rate_ip_window_sec" min="30" max="600" placeholder="60" title="Janela para o rate limit de IP+Device" data-bs-toggle="tooltip">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rate limit por colaborador (por minuto)</label>
                        <input type="number" class="form-control" id="cfg_access_rate_colab_limit" min="2" max="60" placeholder="6" title="Limite de tentativas por colaborador na janela" data-bs-toggle="tooltip">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Janela colaborador (segundos)</label>
                        <input type="number" class="form-control" id="cfg_access_rate_colab_window_sec" min="30" max="600" placeholder="60" title="Janela para o rate limit por colaborador" data-bs-toggle="tooltip">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Exigir geolocalização</label>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="cfg_access_require_geo" title="Se ativo, valida distância do local informado" data-bs-toggle="tooltip">
                            <label class="form-check-label" for="cfg_access_require_geo">Validar distância do local</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Latitude base</label>
                        <input type="number" class="form-control" id="cfg_access_geo_lat" placeholder="-15.79" step="0.000001" title="Latitude do local permitido" data-bs-toggle="tooltip">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Longitude base</label>
                        <input type="number" class="form-control" id="cfg_access_geo_lng" placeholder="-47.88" step="0.000001" title="Longitude do local permitido" data-bs-toggle="tooltip">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Raio permitido (metros)</label>
                        <input type="number" class="form-control" id="cfg_access_geo_radius" placeholder="200" min="10" max="5000" title="Distância máxima (em metros) do local permitido" data-bs-toggle="tooltip">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Exigir SSID</label>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="cfg_access_require_ssid" title="Se ativo, valida o nome da rede Wi-Fi" data-bs-toggle="tooltip">
                            <label class="form-check-label" for="cfg_access_require_ssid">Validar Wi-Fi</label>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">SSID permitido</label>
                        <input type="text" class="form-control" id="cfg_access_allowed_ssid" placeholder="Nome da rede Wi-Fi" title="Nome exato da rede autorizada" data-bs-toggle="tooltip">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Aba Lembretes -->
    <div class="tab-pane fade" id="lembretes" role="tabpanel" aria-labelledby="lembretes-tab">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-bell"></i> Configurações de Lembretes
                </h5>
            </div>
            <div class="card-body">
                <form>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Antecedência Consultas (horas)</label>
                            <input type="number" class="form-control" id="cfg_lembretesConsultasHoras" min="1" max="168">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Antecedência Pagamentos (dias)</label>
                            <input type="number" class="form-control" id="cfg_lembretesPagamentosDias" min="1" max="30">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Horário de Envio</label>
                            <input type="time" class="form-control" id="cfg_lembretesHorario">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Dias de Envio</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_lembretesDias_seg">
                                <label class="form-check-label" for="cfg_lembretesDias_seg">Segunda</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_lembretesDias_ter">
                                <label class="form-check-label" for="cfg_lembretesDias_ter">Terça</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_lembretesDias_qua">
                                <label class="form-check-label" for="cfg_lembretesDias_qua">Quarta</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_lembretesDias_qui">
                                <label class="form-check-label" for="cfg_lembretesDias_qui">Quinta</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_lembretesDias_sex">
                                <label class="form-check-label" for="cfg_lembretesDias_sex">Sexta</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_lembretesDias_sab">
                                <label class="form-check-label" for="cfg_lembretesDias_sab">Sábado</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_lembretesDias_dom">
                                <label class="form-check-label" for="cfg_lembretesDias_dom">Domingo</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_lembretesRepetirFalha">
                                <label class="form-check-label" for="cfg_lembretesRepetirFalha">
                                    Repetir envio em caso de falha
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Aba Agenda -->
    <div class="tab-pane fade" id="agenda" role="tabpanel" aria-labelledby="agenda-tab">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calendar3"></i> Configurações da Agenda
                </h5>
            </div>
            <div class="card-body">
                <form>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Horário Início Padrão</label>
                            <input type="time" class="form-control" id="cfg_agendaInicio">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Horário Fim Padrão</label>
                            <input type="time" class="form-control" id="cfg_agendaFim">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Duração Padrão (minutos)</label>
                            <input type="number" class="form-control" id="cfg_agendaDuracao" min="15" max="240">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Intervalo entre Consultas (minutos)</label>
                            <input type="number" class="form-control" id="cfg_agendaIntervalo" min="0" max="60">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Dias de Funcionamento</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_agendaDias_seg">
                                <label class="form-check-label" for="cfg_agendaDias_seg">Segunda</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_agendaDias_ter">
                                <label class="form-check-label" for="cfg_agendaDias_ter">Terça</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_agendaDias_qua">
                                <label class="form-check-label" for="cfg_agendaDias_qua">Quarta</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_agendaDias_qui">
                                <label class="form-check-label" for="cfg_agendaDias_qui">Quinta</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_agendaDias_sex">
                                <label class="form-check-label" for="cfg_agendaDias_sex">Sexta</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_agendaDias_sab">
                                <label class="form-check-label" for="cfg_agendaDias_sab">Sábado</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_agendaDias_dom">
                                <label class="form-check-label" for="cfg_agendaDias_dom">Domingo</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cfg_agendaBloquearFeriados">
                                <label class="form-check-label" for="cfg_agendaBloquearFeriados">
                                    Bloquear agendamentos em feriados
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Aba Backup -->
    <div class="tab-pane fade" id="backup" role="tabpanel" aria-labelledby="backup-tab">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-cloud-download"></i> Backup e Restauração
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <h6>Backup Automático</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cfg_backupAuto">
                            <label class="form-check-label" for="backupAuto">
                                Habilitar backup automático
                            </label>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Frequência</label>
                            <select class="form-select" id="cfg_backupFrequencia">
                                <option value="daily">Diário</option>
                                <option value="weekly">Semanal</option>
                                <option value="monthly">Mensal</option>
                            </select>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Horário</label>
                            <input type="time" class="form-control" id="cfg_backupHorario">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Backup Manual</h6>
                        <a href="/configuracoes/backup/download" class="btn btn-primary w-100 mb-2">
                            <i class="bi bi-download"></i> Fazer Backup Agora
                        </a>
                        <a href="/configuracoes/backup/download?format=zip" class="btn btn-outline-primary w-100 mb-2">
                            <i class="bi bi-file-zip"></i> Baixar Backup (.zip)
                        </a>
                        <div class="mt-3">
                            <label class="form-label">Último Backup</label>
                            <div class="form-control-plaintext">
                                <span id="cfg_backupUltimo">-</span>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Tamanho do Último Backup</label>
                            <div class="form-control-plaintext">
                                <span id="cfg_backupTamanho">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <h6>Restauração</h6>
                        <form class="input-group" action="/configuracoes/backup/restore" method="POST" enctype="multipart/form-data" data-confirm-message="ATENÇÃO: a restauração pode sobrescrever dados. Tem certeza que deseja continuar?" data-confirm-title="Confirmação" data-confirm-confirm-text="Restaurar" data-confirm-cancel-text="Cancelar" data-confirm-variant="danger">
                            <input type="file" class="form-control" name="backupFile" accept=".sql,.zip" required>
                            <button type="submit" class="btn btn-outline-secondary">
                                <i class="bi bi-upload"></i> Restaurar Backup
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Aba Logs -->
    <div class="tab-pane fade" id="logs" role="tabpanel" aria-labelledby="logs-tab">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-terminal"></i> Logs do Sistema
                </h5>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="limparLogsTela()">
                    <i class="bi bi-trash"></i> Limpar
                </button>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">Exibe as últimas mensagens do console do servidor.</small>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="cfg_logsAuto" checked>
                        <label class="form-check-label" for="cfg_logsAuto">Atualizar automaticamente</label>
                    </div>
                </div>
                <pre id="cfg_logsBox" class="p-3 bg-dark text-light rounded" style="height: 320px; overflow: auto; white-space: pre-wrap;"></pre>
            </div>
        </div>
    </div>
</div>

<script>
async function carregarConfiguracoes() {
    try {
        const resp = await fetch('/api/configuracoes', { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        const data = await resp.json();
        if (!data || !data.success) return;

        const cfg = data.config || {};

        const setVal = (id, v) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.value = v == null ? '' : String(v);
        };
        const setChk = (id, v, defaultVal = false) => {
            const el = document.getElementById(id);
            if (!el) return;
            if (v == null) {
                el.checked = !!defaultVal;
            } else {
                el.checked = String(v) === '1' || String(v).toLowerCase() === 'true';
            }
        };

        setVal('cfg_nome', cfg.CLINICA_NOME);
        setVal('cfg_cnpj', cfg.CLINICA_CNPJ);
        setVal('cfg_telefone', cfg.CLINICA_TELEFONE);
        setVal('cfg_email', cfg.CLINICA_EMAIL);
        setVal('cfg_endereco', cfg.CLINICA_ENDERECO);
        setVal('cfg_cidade', cfg.CLINICA_CIDADE);
        setVal('cfg_estado', cfg.CLINICA_ESTADO);
        setVal('cfg_cep', cfg.CLINICA_CEP);
        setChk('cfg_exibirLogo', cfg.EXIBIR_LOGO_RELATORIOS, true);
        setChk('cfg_modoManutencao', cfg.MODO_MANUTENCAO, false);

        setVal('cfg_smtpHost', cfg.SMTP_HOST);
        setVal('cfg_smtpPort', cfg.SMTP_PORT || '587');
        setChk('cfg_smtpSecure', cfg.SMTP_SECURE, false);
        setVal('cfg_smtpUser', cfg.SMTP_USER);
        setVal('cfg_smtpPass', cfg.SMTP_PASS);
        setVal('cfg_smtpFrom', cfg.SMTP_FROM);
        setVal('cfg_appBaseUrl', cfg.APP_BASE_URL);

        setVal('cfg_whatsappNumber', cfg.WHATSAPP_NUMBER);
        setChk('cfg_whatsappAutoConfirmar', cfg.WHATSAPP_AUTO_CONFIRMAR, true);
        setChk('cfg_whatsappEnviarLembretes', cfg.WHATSAPP_ENVIAR_LEMBRETES, true);
        setVal('cfg_whatsappMensagemPadrao', cfg.WHATSAPP_MENSAGEM_PADRAO || 'Olá {nome}! Seu agendamento está confirmado para {data} às {hora}. Compareça com 15 minutos de antecedência.');

        setVal('cfg_lembretesConsultasHoras', cfg.LEMBRETES_ANTECEDENCIA_CONSULTAS_HORAS || '24');
        setVal('cfg_lembretesPagamentosDias', cfg.LEMBRETES_ANTECEDENCIA_PAGAMENTOS_DIAS || '7');
        setVal('cfg_lembretesHorario', cfg.LEMBRETES_HORARIO_ENVIO || '08:00');
        setChk('cfg_lembretesRepetirFalha', cfg.LEMBRETES_REPETIR_FALHA, true);
        setChk('cfg_lembretesDias_seg', cfg.LEMBRETES_DIAS_SEG, true);
        setChk('cfg_lembretesDias_ter', cfg.LEMBRETES_DIAS_TER, true);
        setChk('cfg_lembretesDias_qua', cfg.LEMBRETES_DIAS_QUA, true);
        setChk('cfg_lembretesDias_qui', cfg.LEMBRETES_DIAS_QUI, true);
        setChk('cfg_lembretesDias_sex', cfg.LEMBRETES_DIAS_SEX, true);
        setChk('cfg_lembretesDias_sab', cfg.LEMBRETES_DIAS_SAB, false);
        setChk('cfg_lembretesDias_dom', cfg.LEMBRETES_DIAS_DOM, false);

        setVal('cfg_agendaInicio', cfg.AGENDA_HORARIO_INICIO || '07:00');
        setVal('cfg_agendaFim', cfg.AGENDA_HORARIO_FIM || '20:00');
        setVal('cfg_agendaDuracao', cfg.AGENDA_DURACAO_PADRAO_MINUTOS || '30');
        setVal('cfg_agendaIntervalo', cfg.AGENDA_INTERVALO_MINUTOS || '15');
        setChk('cfg_agendaBloquearFeriados', cfg.AGENDA_BLOQUEAR_FERIADOS, true);
        setChk('cfg_agendaDias_seg', cfg.AGENDA_DIAS_SEG, true);
        setChk('cfg_agendaDias_ter', cfg.AGENDA_DIAS_TER, true);
        setChk('cfg_agendaDias_qua', cfg.AGENDA_DIAS_QUA, true);
        setChk('cfg_agendaDias_qui', cfg.AGENDA_DIAS_QUI, true);
        setChk('cfg_agendaDias_sex', cfg.AGENDA_DIAS_SEX, true);
        setChk('cfg_agendaDias_sab', cfg.AGENDA_DIAS_SAB, false);
        setChk('cfg_agendaDias_dom', cfg.AGENDA_DIAS_DOM, false);

        setVal('cfg_access_hmac_secret', cfg.ACCESS_HMAC_SECRET || '');
        setVal('cfg_access_qr_mode', (cfg.ACCESS_QR_MODE || 'fixed').toString().toLowerCase());
        setVal('cfg_access_qr_ttl_sec', cfg.ACCESS_QR_TOKEN_TTL_SEC || '30');
        setChk('cfg_access_device_whitelist_enabled', cfg.ACCESS_DEVICE_WHITELIST_ENABLED, false);
        setChk('cfg_access_device_whitelist_auto_add', cfg.ACCESS_DEVICE_WHITELIST_AUTO_ADD, false);
        setVal('cfg_access_device_ttl_days', cfg.ACCESS_DEVICE_ID_TTL_DAYS || '180');
        setVal('cfg_access_ponto_dup_minutes', cfg.ACCESS_PONTO_DUP_MINUTES || '3');
        setVal('cfg_access_rate_ip_limit', cfg.ACCESS_PONTO_RATE_IP_LIMIT || '10');
        setVal('cfg_access_rate_ip_window_sec', cfg.ACCESS_PONTO_RATE_IP_WINDOW_SEC || '60');
        setVal('cfg_access_rate_colab_limit', cfg.ACCESS_PONTO_RATE_COLAB_LIMIT || '6');
        setVal('cfg_access_rate_colab_window_sec', cfg.ACCESS_PONTO_RATE_COLAB_WINDOW_SEC || '60');
        setChk('cfg_access_require_geo', cfg.ACCESS_REQUIRE_GEO, false);
        setVal('cfg_access_geo_lat', cfg.ACCESS_GEO_LAT || '');
        setVal('cfg_access_geo_lng', cfg.ACCESS_GEO_LNG || '');
        setVal('cfg_access_geo_radius', cfg.ACCESS_GEO_RADIUS_METERS || '200');
        setChk('cfg_access_require_ssid', cfg.ACCESS_REQUIRE_SSID, false);
        setVal('cfg_access_allowed_ssid', cfg.ACCESS_ALLOWED_SSID || '');

        setChk('cfg_backupAuto', cfg.BACKUP_AUTO, true);
        setVal('cfg_backupFrequencia', cfg.BACKUP_FREQUENCIA || 'daily');
        setVal('cfg_backupHorario', cfg.BACKUP_HORARIO || '02:00');

        setChk('cfg_perm_financeiro_medico_ver', cfg.PERM_FINANCEIRO_MEDICO_VER, false);
        setChk('cfg_perm_financeiro_medico_lancar', cfg.PERM_FINANCEIRO_MEDICO_LANCAR, false);

        const elUltimo = document.getElementById('cfg_backupUltimo');
        const elTamanho = document.getElementById('cfg_backupTamanho');
        if (elUltimo) elUltimo.textContent = cfg.BACKUP_LAST_AT ? String(cfg.BACKUP_LAST_AT) : '-';
        if (elTamanho) elTamanho.textContent = cfg.BACKUP_LAST_SIZE ? String(cfg.BACKUP_LAST_SIZE) : '-';
    } catch (e) {
        console.error('Erro ao carregar configurações:', e);
    }
}

async function salvarConfiguracoes() {
    try {
        const clamp = (value, min, max, fallback) => {
            const n = Number(value);
            if (!Number.isFinite(n)) return fallback;
            return Math.min(max, Math.max(min, n));
        };
        const cfg = {
            CLINICA_NOME: document.getElementById('cfg_nome')?.value || '',
            CLINICA_CNPJ: document.getElementById('cfg_cnpj')?.value || '',
            CLINICA_TELEFONE: document.getElementById('cfg_telefone')?.value || '',
            CLINICA_EMAIL: document.getElementById('cfg_email')?.value || '',
            CLINICA_ENDERECO: document.getElementById('cfg_endereco')?.value || '',
            CLINICA_CIDADE: document.getElementById('cfg_cidade')?.value || '',
            CLINICA_ESTADO: document.getElementById('cfg_estado')?.value || '',
            CLINICA_CEP: document.getElementById('cfg_cep')?.value || '',
            EXIBIR_LOGO_RELATORIOS: document.getElementById('cfg_exibirLogo')?.checked ? '1' : '0',
            MODO_MANUTENCAO: document.getElementById('cfg_modoManutencao')?.checked ? '1' : '0',

            SMTP_HOST: document.getElementById('cfg_smtpHost')?.value || '',
            SMTP_PORT: document.getElementById('cfg_smtpPort')?.value || '',
            SMTP_SECURE: document.getElementById('cfg_smtpSecure')?.checked ? '1' : '0',
            SMTP_USER: document.getElementById('cfg_smtpUser')?.value || '',
            SMTP_PASS: document.getElementById('cfg_smtpPass')?.value || '',
            SMTP_FROM: document.getElementById('cfg_smtpFrom')?.value || '',
            APP_BASE_URL: document.getElementById('cfg_appBaseUrl')?.value || '',

            WHATSAPP_NUMBER: document.getElementById('cfg_whatsappNumber')?.value || '',
            WHATSAPP_AUTO_CONFIRMAR: document.getElementById('cfg_whatsappAutoConfirmar')?.checked ? '1' : '0',
            WHATSAPP_ENVIAR_LEMBRETES: document.getElementById('cfg_whatsappEnviarLembretes')?.checked ? '1' : '0',
            WHATSAPP_MENSAGEM_PADRAO: document.getElementById('cfg_whatsappMensagemPadrao')?.value || '',

            LEMBRETES_ANTECEDENCIA_CONSULTAS_HORAS: document.getElementById('cfg_lembretesConsultasHoras')?.value || '24',
            LEMBRETES_ANTECEDENCIA_PAGAMENTOS_DIAS: document.getElementById('cfg_lembretesPagamentosDias')?.value || '7',
            LEMBRETES_HORARIO_ENVIO: document.getElementById('cfg_lembretesHorario')?.value || '08:00',
            LEMBRETES_REPETIR_FALHA: document.getElementById('cfg_lembretesRepetirFalha')?.checked ? '1' : '0',
            LEMBRETES_DIAS_SEG: document.getElementById('cfg_lembretesDias_seg')?.checked ? '1' : '0',
            LEMBRETES_DIAS_TER: document.getElementById('cfg_lembretesDias_ter')?.checked ? '1' : '0',
            LEMBRETES_DIAS_QUA: document.getElementById('cfg_lembretesDias_qua')?.checked ? '1' : '0',
            LEMBRETES_DIAS_QUI: document.getElementById('cfg_lembretesDias_qui')?.checked ? '1' : '0',
            LEMBRETES_DIAS_SEX: document.getElementById('cfg_lembretesDias_sex')?.checked ? '1' : '0',
            LEMBRETES_DIAS_SAB: document.getElementById('cfg_lembretesDias_sab')?.checked ? '1' : '0',
            LEMBRETES_DIAS_DOM: document.getElementById('cfg_lembretesDias_dom')?.checked ? '1' : '0',

            AGENDA_HORARIO_INICIO: document.getElementById('cfg_agendaInicio')?.value || '07:00',
            AGENDA_HORARIO_FIM: document.getElementById('cfg_agendaFim')?.value || '20:00',
            AGENDA_DURACAO_PADRAO_MINUTOS: document.getElementById('cfg_agendaDuracao')?.value || '30',
            AGENDA_INTERVALO_MINUTOS: document.getElementById('cfg_agendaIntervalo')?.value || '15',
            AGENDA_BLOQUEAR_FERIADOS: document.getElementById('cfg_agendaBloquearFeriados')?.checked ? '1' : '0',
            AGENDA_DIAS_SEG: document.getElementById('cfg_agendaDias_seg')?.checked ? '1' : '0',
            AGENDA_DIAS_TER: document.getElementById('cfg_agendaDias_ter')?.checked ? '1' : '0',
            AGENDA_DIAS_QUA: document.getElementById('cfg_agendaDias_qua')?.checked ? '1' : '0',
            AGENDA_DIAS_QUI: document.getElementById('cfg_agendaDias_qui')?.checked ? '1' : '0',
            AGENDA_DIAS_SEX: document.getElementById('cfg_agendaDias_sex')?.checked ? '1' : '0',
            AGENDA_DIAS_SAB: document.getElementById('cfg_agendaDias_sab')?.checked ? '1' : '0',
            AGENDA_DIAS_DOM: document.getElementById('cfg_agendaDias_dom')?.checked ? '1' : '0',

            BACKUP_AUTO: document.getElementById('cfg_backupAuto')?.checked ? '1' : '0',
            BACKUP_FREQUENCIA: document.getElementById('cfg_backupFrequencia')?.value || 'daily',
            BACKUP_HORARIO: document.getElementById('cfg_backupHorario')?.value || '02:00',

            ACCESS_QR_MODE: document.getElementById('cfg_access_qr_mode')?.value || 'fixed',
            ACCESS_HMAC_SECRET: document.getElementById('cfg_access_hmac_secret')?.value || '',
            ACCESS_QR_TOKEN_TTL_SEC: document.getElementById('cfg_access_qr_ttl_sec')?.value || '30',
            ACCESS_DEVICE_WHITELIST_ENABLED: document.getElementById('cfg_access_device_whitelist_enabled')?.checked ? '1' : '0',
            ACCESS_DEVICE_WHITELIST_AUTO_ADD: document.getElementById('cfg_access_device_whitelist_auto_add')?.checked ? '1' : '0',
            ACCESS_DEVICE_ID_TTL_DAYS: String(clamp(document.getElementById('cfg_access_device_ttl_days')?.value, 30, 365, 180)),
            ACCESS_PONTO_DUP_MINUTES: String(clamp(document.getElementById('cfg_access_ponto_dup_minutes')?.value, 1, 15, 3)),
            ACCESS_PONTO_RATE_IP_LIMIT: String(clamp(document.getElementById('cfg_access_rate_ip_limit')?.value, 2, 60, 10)),
            ACCESS_PONTO_RATE_IP_WINDOW_SEC: String(clamp(document.getElementById('cfg_access_rate_ip_window_sec')?.value, 30, 600, 60)),
            ACCESS_PONTO_RATE_COLAB_LIMIT: String(clamp(document.getElementById('cfg_access_rate_colab_limit')?.value, 2, 60, 6)),
            ACCESS_PONTO_RATE_COLAB_WINDOW_SEC: String(clamp(document.getElementById('cfg_access_rate_colab_window_sec')?.value, 30, 600, 60)),
            ACCESS_REQUIRE_GEO: document.getElementById('cfg_access_require_geo')?.checked ? '1' : '0',
            ACCESS_GEO_LAT: document.getElementById('cfg_access_geo_lat')?.value || '',
            ACCESS_GEO_LNG: document.getElementById('cfg_access_geo_lng')?.value || '',
            ACCESS_GEO_RADIUS_METERS: document.getElementById('cfg_access_geo_radius')?.value || '200',
            ACCESS_REQUIRE_SSID: document.getElementById('cfg_access_require_ssid')?.checked ? '1' : '0',
            ACCESS_ALLOWED_SSID: document.getElementById('cfg_access_allowed_ssid')?.value || '',

            PERM_FINANCEIRO_MEDICO_VER: document.getElementById('cfg_perm_financeiro_medico_ver')?.checked ? '1' : '0',
            PERM_FINANCEIRO_MEDICO_LANCAR: document.getElementById('cfg_perm_financeiro_medico_lancar')?.checked ? '1' : '0'
        };

        const resp = await fetch('/api/configuracoes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ config: cfg })
        });
        const data = await resp.json();
        if (data && data.success) {
            if (window.app && window.app.utils && window.app.utils.showNotification) {
                window.app.utils.showNotification('Configurações salvas com sucesso!', 'success');
            }
        } else {
            const msg = (data && (data.message || data.error)) ? (data.message || data.error) : 'Erro ao salvar configurações';
            if (window.app && window.app.utils && window.app.utils.showNotification) {
                window.app.utils.showNotification(msg, 'danger');
            }
        }
    } catch (e) {
        console.error('Erro ao salvar configurações:', e);
        if (window.app && window.app.utils && window.app.utils.showNotification) {
            window.app.utils.showNotification('Erro ao salvar configurações', 'danger');
        }
    }
}

async function configWhatsappReconectar() {
    try {
        await fetch('/api/whatsapp/reactivate-teste', { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        if (window.app && window.app.whatsapp) {
            setTimeout(window.app.whatsapp.checkStatus, 1500);
        }
    } catch (e) {
        console.error(e);
    }
}

async function configWhatsappNovoQr() {
    try {
        await fetch('/api/whatsapp/qrcode-teste', { method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
    } catch (e) {
        console.error(e);
    }
}

async function configWhatsappTeste() {
    try {
        if (window.app && window.app.whatsapp) {
            await window.app.whatsapp.sendTestMessage();
        }
    } catch (e) {
        console.error(e);
    }
}

let logsLastTs = 0;
let logsTimer = null;
function limparLogsTela() {
    const box = document.getElementById('cfg_logsBox');
    if (box) box.textContent = '';
    logsLastTs = 0;
}

async function carregarLogs() {
    try {
        const auto = document.getElementById('cfg_logsAuto');
        if (auto && !auto.checked) return;

        const resp = await fetch(`/api/logs?limit=200&since=${encodeURIComponent(String(logsLastTs || 0))}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        const data = await resp.json();
        if (!data || !data.success) return;

        const logs = Array.isArray(data.logs) ? data.logs : [];
        if (!logs.length) return;

        const box = document.getElementById('cfg_logsBox');
        if (!box) return;

        const shouldStickBottom = (box.scrollTop + box.clientHeight + 50) >= box.scrollHeight;

        const lines = logs.map(l => {
            const at = l.at || '';
            const lvl = (l.level || 'log').toString().toUpperCase();
            const msg = l.message || '';
            return `[${at}] ${lvl}: ${msg}`;
        }).join('\n') + '\n';

        box.textContent += lines;
        logsLastTs = Number(logs[logs.length - 1].ts || logsLastTs);

        if (shouldStickBottom) {
            box.scrollTop = box.scrollHeight;
        }
    } catch (e) {
        // ignore
    }
}

document.addEventListener('DOMContentLoaded', () => {
    try {
        const tabs = document.getElementById('configTabs');
        if (tabs) {
            tabs.addEventListener('click', (e) => {
                try {
                    const target = e && e.target ? e.target : null;
                    const btn = target ? target.closest('[data-bs-toggle="tab"]') : null;
                    if (!btn) return;
                    const bsOk = !!(window.bootstrap && window.bootstrap.Tab);
                    if (bsOk) {
                        const inst = window.bootstrap.Tab.getOrCreateInstance(btn);
                        inst.show();
                        return;
                    }

                    e.preventDefault();

                    const sel = btn.getAttribute('data-bs-target');
                    if (!sel) return;

                    tabs.querySelectorAll('.nav-link').forEach((b) => {
                        b.classList.remove('active');
                        b.setAttribute('aria-selected', 'false');
                    });
                    btn.classList.add('active');
                    btn.setAttribute('aria-selected', 'true');

                    const content = document.getElementById('configTabContent');
                    if (content) {
                        content.querySelectorAll('.tab-pane').forEach((p) => {
                            p.classList.remove('active');
                            p.classList.remove('show');
                        });
                    }
                    const pane = document.querySelector(sel);
                    if (pane) {
                        pane.classList.add('active');
                        pane.classList.add('show');
                    }

                    if (sel === '#logs') {
                        carregarLogs();
                        if (logsTimer) clearInterval(logsTimer);
                        logsTimer = setInterval(carregarLogs, 2000);
                    } else {
                        if (logsTimer) {
                            clearInterval(logsTimer);
                            logsTimer = null;
                        }
                    }
                } catch (err) {
                    // ignore
                }
            }, true);

            tabs.addEventListener('shown.bs.tab', (event) => {
                const target = event && event.target ? event.target.getAttribute('data-bs-target') : '';
                if (target === '#logs') {
                    carregarLogs();
                    if (logsTimer) clearInterval(logsTimer);
                    logsTimer = setInterval(carregarLogs, 2000);
                } else {
                    if (logsTimer) {
                        clearInterval(logsTimer);
                        logsTimer = null;
                    }
                }
            });
        }
    } catch (e) {
        // ignore
    }
});

document.addEventListener('DOMContentLoaded', function() {
    carregarConfiguracoes();
});
</script>
