<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="bi bi-bar-chart"></i> Estatísticas</h3>
</div>

<div class="row g-4 mb-4">
    <div class="col-6 col-lg-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-muted small" data-bs-toggle="tooltip" data-bs-placement="top" title="Quantidade de pacientes com cadastro ativo no sistema.">Pacientes ativos</div>
                        <div class="fs-4 fw-semibold"><%= kpis.totalPacientes || 0 %></div>
                    </div>
                    <div class="text-primary fs-3"><i class="bi bi-people"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-6 col-lg-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-muted small" data-bs-toggle="tooltip" data-bs-placement="top" title="Total de agendamentos com data marcada para hoje.">Agendamentos hoje</div>
                        <div class="fs-4 fw-semibold"><%= kpis.agendamentosHoje || 0 %></div>
                    </div>
                    <div class="text-success fs-3"><i class="bi bi-calendar-check"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-6 col-lg-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-muted small" data-bs-toggle="tooltip" data-bs-placement="top" title="Total de agendamentos do mês atual.">Agendamentos no mês</div>
                        <div class="fs-4 fw-semibold"><%= kpis.agendamentosMes || 0 %></div>
                    </div>
                    <div class="text-info fs-3"><i class="bi bi-calendar3"></i></div>
                </div>
                <div class="mt-3">
                    <div class="d-flex justify-content-between small text-muted">
                        <div data-bs-toggle="tooltip" data-bs-placement="top" title="Percentual de agendamentos do mês marcados como Confirmado ou Realizado.">Taxa de confirmação</div>
                        <div><%= ((kpis.taxaConfirmacaoMes || 0) * 100).toFixed(0) %>%</div>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-info" role="progressbar" style="width: <%= Math.min(100, Math.max(0, (kpis.taxaConfirmacaoMes || 0) * 100)) %>%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-6 col-lg-3">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-muted small" data-bs-toggle="tooltip" data-bs-placement="top" title="Saldo do mês (Receitas - Despesas) conforme lançamentos do Financeiro.">Saldo do mês</div>
                        <div class="fs-4 fw-semibold">R$ <%= (kpis.saldoMes || 0).toFixed(2).replace('.', ',') %></div>
                    </div>
                    <div class="text-warning fs-3"><i class="bi bi-cash-coin"></i></div>
                </div>
                <div class="small text-muted mt-2">
                    Receitas: R$ <%= (kpis.receitasMes || 0).toFixed(2).replace('.', ',') %>
                    <br>
                    Despesas: R$ <%= (kpis.despesasMes || 0).toFixed(2).replace('.', ',') %>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof bootstrap === 'undefined' || !bootstrap.Tooltip) return;
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function (el) {
            new bootstrap.Tooltip(el);
        });
    });
</script>

<div class="row g-4">
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <div class="d-flex align-items-center justify-content-between">
                    <h5 class="card-title mb-0" data-bs-toggle="tooltip" data-bs-placement="top" title="Resumo e distribuição de lembretes cadastrados no sistema."><i class="bi bi-bell"></i> Lembretes</h5>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-4">
                        <div class="p-3 rounded border">
                            <div class="text-muted small" data-bs-toggle="tooltip" data-bs-placement="top" title="Lembretes com status Pendente.">Pendentes</div>
                            <div class="fs-5 fw-semibold"><%= kpis.lembretesPendentes || 0 %></div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-3 rounded border">
                            <div class="text-muted small" data-bs-toggle="tooltip" data-bs-placement="top" title="Lembretes com status Enviado.">Enviados</div>
                            <div class="fs-5 fw-semibold"><%= kpis.lembretesEnviados || 0 %></div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-3 rounded border">
                            <div class="text-muted small" data-bs-toggle="tooltip" data-bs-placement="top" title="Lembretes com falha de envio.">Erro</div>
                            <div class="fs-5 fw-semibold"><%= kpis.lembretesErro || 0 %></div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="small text-muted mb-2">Distribuição por status (mês atual)</div>
                    <div class="d-flex flex-column gap-2">
                        <% const stLabels = { agendado: 'Agendado', confirmado: 'Confirmado', realizado: 'Realizado', cancelado: 'Cancelado' }; %>
                        <% const stKeys = ['agendado', 'confirmado', 'realizado', 'cancelado']; %>
                        <% const stBar = { agendado: 'bg-info', confirmado: 'bg-success', realizado: 'bg-primary', cancelado: 'bg-danger' }; %>
                        <% const totalSt = (kpis.agendamentosMes || 0); %>
                        <% stKeys.forEach(k => { %>
                            <% const v = (statusMes && statusMes[k]) ? Number(statusMes[k]) : 0; %>
                            <div>
                                <div class="d-flex justify-content-between small">
                                    <div class="text-muted"><%= stLabels[k] %></div>
                                    <div class="text-muted"><%= v %></div>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar <%= stBar[k] || 'bg-secondary' %>" role="progressbar" style="width: <%= totalSt > 0 ? (v * 100 / totalSt) : 0 %>%;"></div>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0" data-bs-toggle="tooltip" data-bs-placement="top" title="Profissionais com mais atendimentos nos últimos 30 dias."><i class="bi bi-person-badge"></i> Top profissionais (últimos 30 dias)</h5>
            </div>
            <div class="card-body">
                <% if (topProfissionais30 && topProfissionais30.length) { %>
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>Profissional</th>
                                    <th class="text-end">Atendimentos</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% topProfissionais30.forEach(r => { %>
                                    <tr>
                                        <td><%= r.profissional_nome %></td>
                                        <td class="text-end"><%= r.total %></td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <div class="text-muted">Sem dados para exibir.</div>
                <% } %>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0" data-bs-toggle="tooltip" data-bs-placement="top" title="Pacientes com mais agendamentos não cancelados nos últimos 180 dias."><i class="bi bi-heart"></i> Pacientes mais fiéis (últimos 180 dias)</h5>
            </div>
            <div class="card-body">
                <% if (topPacientesFieis && topPacientesFieis.length) { %>
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>Paciente</th>
                                    <th class="text-end">Atendimentos</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% topPacientesFieis.forEach(r => { %>
                                    <tr>
                                        <td><%= r.paciente_nome %></td>
                                        <td class="text-end"><%= r.total %></td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                    <div class="text-muted small mt-2">Base: agendamentos não cancelados.</div>
                <% } else { %>
                    <div class="text-muted">Sem dados para exibir.</div>
                <% } %>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0" data-bs-toggle="tooltip" data-bs-placement="top" title="Pacientes ativos sem atendimentos há mais de 60 dias."><i class="bi bi-exclamation-triangle"></i> Pacientes em risco (sem retorno há 60 dias)</h5>
            </div>
            <div class="card-body">
                <% if (pacientesEmRisco && pacientesEmRisco.length) { %>
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>Paciente</th>
                                    <th class="text-end">Última visita</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% pacientesEmRisco.forEach(r => { %>
                                    <tr>
                                        <td><%= r.nome %></td>
                                        <td class="text-end"><%= r.ultima_visita ? r.ultima_visita : 'Nunca' %></td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                    <div class="text-muted small mt-2">Sugestão: criar campanha de retorno/reativação.</div>
                <% } else { %>
                    <div class="text-muted">Sem dados para exibir.</div>
                <% } %>
            </div>
        </div>
    </div>

    <div class="col-lg-7">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0" data-bs-toggle="tooltip" data-bs-placement="top" title="Quantidade de agendamentos por dia nos próximos 7 dias."><i class="bi bi-calendar-week"></i> Próximos 7 dias</h5>
            </div>
            <div class="card-body">
                <% if (proximos7Dias && proximos7Dias.length) { %>
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>Dia</th>
                                    <th class="text-end">Agendamentos</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% proximos7Dias.forEach(r => { %>
                                    <tr>
                                        <td><%= r.dia %></td>
                                        <td class="text-end"><%= r.total %></td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                <% } else { %>
                    <div class="text-muted">Sem dados para exibir.</div>
                <% } %>
            </div>
        </div>
    </div>

    <div class="col-lg-5">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0" data-bs-toggle="tooltip" data-bs-placement="top" title="Distribuição das receitas do mês por categoria (Financeiro)."><i class="bi bi-tags"></i> Receitas por categoria (mês)</h5>
            </div>
            <div class="card-body">
                <% if (receitaCategoriaMes && receitaCategoriaMes.length) { %>
                    <div class="d-flex flex-column gap-3">
                        <% const totalCat = receitaCategoriaMes.reduce((s, r) => s + Number(r.total || 0), 0); %>
                        <% receitaCategoriaMes.forEach(r => { %>
                            <div>
                                <div class="d-flex justify-content-between small">
                                    <div class="text-muted"><%= r.categoria %></div>
                                    <div class="text-muted">R$ <%= Number(r.total || 0).toFixed(2).replace('.', ',') %></div>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: <%= totalCat > 0 ? (Number(r.total || 0) * 100 / totalCat) : 0 %>%"></div>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                <% } else { %>
                    <div class="text-muted">Sem dados para exibir.</div>
                <% } %>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0" data-bs-toggle="tooltip" data-bs-placement="top" title="Lista de pacientes aniversariantes (próximos dias e mês atual)."><i class="bi bi-gift"></i> Aniversariantes</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="fw-semibold mb-2">Próximos 7 dias</div>
                        <% if (aniversariantesSemana && aniversariantesSemana.length) { %>
                            <div class="table-responsive">
                                <table class="table table-sm align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th>Paciente</th>
                                            <th class="text-end">Nascimento</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% aniversariantesSemana.forEach(r => { %>
                                            <tr>
                                                <td><%= r.nome %></td>
                                                <td class="text-end"><%= r.data_nascimento %></td>
                                            </tr>
                                        <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        <% } else { %>
                            <div class="text-muted">Sem aniversariantes nos próximos dias.</div>
                        <% } %>
                    </div>

                    <div class="col-md-6">
                        <div class="fw-semibold mb-2">Neste mês</div>
                        <% if (aniversariantesMes && aniversariantesMes.length) { %>
                            <div class="table-responsive">
                                <table class="table table-sm align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th>Paciente</th>
                                            <th class="text-end">Nascimento</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% aniversariantesMes.slice(0, 15).forEach(r => { %>
                                            <tr>
                                                <td><%= r.nome %></td>
                                                <td class="text-end"><%= r.data_nascimento %></td>
                                            </tr>
                                        <% }) %>
                                    </tbody>
                                </table>
                            </div>
                            <% if (aniversariantesMes.length > 15) { %>
                                <div class="text-muted small mt-2">Mostrando 15 de <%= aniversariantesMes.length %>.</div>
                            <% } %>
                        <% } else { %>
                            <div class="text-muted">Sem aniversariantes neste mês.</div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0" data-bs-toggle="tooltip" data-bs-placement="top" title="Monitoramento de lembretes: próximos envios e falhas recentes."><i class="bi bi-send"></i> Operação de lembretes</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="fw-semibold mb-2">Próximos (24h)</div>
                        <% if (lembretesProximos && lembretesProximos.length) { %>
                            <div class="table-responsive">
                                <table class="table table-sm align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th>Paciente</th>
                                            <th class="text-end">Envio</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% lembretesProximos.forEach(r => { %>
                                            <tr>
                                                <td><%= r.paciente_nome %></td>
                                                <td class="text-end"><%= r.data_envio %></td>
                                            </tr>
                                        <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        <% } else { %>
                            <div class="text-muted">Sem lembretes pendentes para as próximas 24h.</div>
                        <% } %>
                    </div>

                    <div class="col-md-6">
                        <div class="fw-semibold mb-2">Falhas recentes (7 dias)</div>
                        <% if (lembretesFalhasRecentes && lembretesFalhasRecentes.length) { %>
                            <div class="table-responsive">
                                <table class="table table-sm align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th>Paciente</th>
                                            <th class="text-end">Tentativas</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% lembretesFalhasRecentes.forEach(r => { %>
                                            <tr>
                                                <td>
                                                    <div class="fw-semibold"><%= r.paciente_nome %></div>
                                                    <% if (r.ultimo_erro) { %>
                                                        <div class="text-muted small text-truncate" style="max-width: 240px;"><%= r.ultimo_erro %></div>
                                                    <% } %>
                                                </td>
                                                <td class="text-end"><%= r.tentativas %></td>
                                            </tr>
                                        <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        <% } else { %>
                            <div class="text-muted">Sem falhas recentes.</div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
