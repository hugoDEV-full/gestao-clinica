<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="bi bi-people-fill"></i> Usuários</h3>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalUsuario">
        <i class="bi bi-plus-circle"></i> Novo Usuário
    </button>
</div>

<!-- Modal Alterar Permissão (Tipo) -->
<div class="modal fade" id="modalTipoUsuario" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Alterar Permissão do Usuário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="tipoUsuarioId" />
                <div class="mb-3">
                    <label class="form-label">Senha do Admin (confirmação) *</label>
                    <input type="password" class="form-control" id="tipoAdminSenha" autocomplete="current-password" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Tipo (papel) *</label>
                    <select class="form-select" id="tipoUsuarioSelect">
                        <option value="admin">Administrador</option>
                        <option value="secretaria">Secretária</option>
                        <option value="medico">Médico</option>
                        <option value="paciente">Paciente</option>
                    </select>
                    <small class="text-muted">Isso altera as permissões de acesso do usuário no sistema.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnSalvarTipoUsuario">Salvar</button>
            </div>
        </div>
    </div>
</div>

<% const listaUsuarios = Array.isArray(usuarios) ? usuarios : []; %>

<div id="usuariosAlert" class="alert d-none" role="alert"></div>

<!-- Lista de Usuários -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="bi bi-list-ul"></i> Usuários Cadastrados
        </h5>
        <div class="input-group" style="max-width: 300px;">
            <span class="input-group-text">
                <i class="bi bi-search"></i>
            </span>
            <input type="text" class="form-control" placeholder="Buscar usuário...">
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Tipo</th>
                        <th>CPF</th>
                        <th>Telefone</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (listaUsuarios.length === 0) { %>
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">Nenhum usuário encontrado.</td>
                    </tr>
                    <% } %>

                    <% listaUsuarios.forEach((u) => { %>
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                    <%= (u.nome || 'U').toString().trim().slice(0, 1).toUpperCase() %>
                                </div>
                                <div>
                                    <div class="fw-bold"><%= u.nome %></div>
                                </div>
                            </div>
                        </td>
                        <td><%= u.email %></td>
                        <td>
                            <% const tipo = (u.tipo || '').toString().trim().toLowerCase(); %>
                            <% if (tipo === 'admin') { %>
                                <span class="badge bg-danger">Administrador</span>
                            <% } else if (tipo === 'medico') { %>
                                <span class="badge bg-primary">Médico</span>
                            <% } else if (tipo === 'secretaria') { %>
                                <span class="badge bg-secondary">Secretária</span>
                            <% } else if (tipo === 'paciente') { %>
                                <span class="badge bg-info text-dark">Paciente</span>
                            <% } else { %>
                                <span class="badge bg-secondary"><%= u.tipo %></span>
                            <% } %>
                        </td>
                        <td><%= u.cpf || '-' %></td>
                        <td><%= u.telefone || '-' %></td>
                        <td>
                            <% if (u.ativo) { %>
                                <span class="badge bg-success">Ativo</span>
                            <% } else { %>
                                <span class="badge bg-danger">Inativo</span>
                            <% } %>
                        </td>
                        <td>
                            <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="Alterar permissão (tipo)" data-user-id="<%= u.id %>" data-user-tipo="<%= (u.tipo || '').toString() %>" onclick="openTipoModalFromBtn(this)">
                                    <i class="bi bi-shield-lock"></i>
                                </button>
                                <% if (u.ativo) { %>
                                    <button type="button" class="btn btn-sm btn-outline-warning" data-bs-toggle="tooltip" data-bs-placement="top" title="Inativar usuário" onclick="toggleUsuarioAtivo('<%= u.id %>', 0)">
                                        <i class="bi bi-person-x"></i>
                                    </button>
                                <% } else { %>
                                    <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="tooltip" data-bs-placement="top" title="Ativar usuário" onclick="toggleUsuarioAtivo('<%= u.id %>', 1)">
                                        <i class="bi bi-person-check"></i>
                                    </button>
                                <% } %>
                            </div>
                        </td>
                    </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal de Novo Usuário -->
<div class="modal fade" id="modalUsuario" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Novo Usuário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="novoUsuarioForm">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Senha do Admin (confirmação) *</label>
                            <input type="password" class="form-control" name="adminSenha" required autocomplete="current-password">
                            <small class="text-muted">Por segurança, confirme sua senha de admin para cadastrar.</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nome Completo *</label>
                            <input type="text" class="form-control" name="nome" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tipo *</label>
                            <select class="form-select" name="tipo" required>
                                <option value="admin">Administrador</option>
                                <option value="secretaria">Secretária</option>
                                <option value="medico">Médico</option>
                                <option value="paciente">Paciente</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">CPF</label>
                            <input type="text" class="form-control" name="cpf">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Telefone</label>
                            <input type="tel" class="form-control" name="telefone">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Senha *</label>
                            <input type="password" class="form-control" name="senha" required autocomplete="new-password">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Confirmar Senha *</label>
                            <input type="password" class="form-control" name="confirmarSenha" required autocomplete="new-password">
                        </div>
                        <div class="col-12">
                            <small class="text-muted">
                                A senha deve ter no mínimo 8 caracteres, conter maiúscula, minúscula, número e caractere especial.
                            </small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnCadastrarUsuario">Cadastrar Usuário</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const alertBox = document.getElementById('usuariosAlert');
        const form = document.getElementById('novoUsuarioForm');
        const btn = document.getElementById('btnCadastrarUsuario');
        const modalEl = document.getElementById('modalUsuario');
        const tipoModalEl = document.getElementById('modalTipoUsuario');
        const tipoUsuarioIdEl = document.getElementById('tipoUsuarioId');
        const tipoAdminSenhaEl = document.getElementById('tipoAdminSenha');
        const tipoSelectEl = document.getElementById('tipoUsuarioSelect');
        const btnSalvarTipo = document.getElementById('btnSalvarTipoUsuario');

        function showAlert(type, msg) {
            if (!alertBox) return;
            const map = {
                success: { klass: 'success', icon: 'bi-check-circle', label: 'Sucesso' },
                danger: { klass: 'danger', icon: 'bi-exclamation-triangle', label: 'Erro' },
                warning: { klass: 'warning', icon: 'bi-exclamation-circle', label: 'Atenção' },
                info: { klass: 'info', icon: 'bi-info-circle', label: 'Informação' }
            };
            const m = map[type] || map.danger;
            alertBox.className = `alert alert-${m.klass} alert-dismissible fade show`;
            alertBox.innerHTML = `
                <div class="d-flex align-items-start gap-2">
                    <i class="bi ${m.icon}"></i>
                    <div class="flex-grow-1">
                        <div class="fw-semibold">${m.label}</div>
                        <div>${String(msg || '').replace(/</g, '&lt;')}</div>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            alertBox.classList.remove('d-none');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        if (!btn || !form) return;

        window.openTipoModal = function (id, tipoAtual) {
            if (!tipoModalEl || !tipoUsuarioIdEl || !tipoAdminSenhaEl || !tipoSelectEl) return;
            tipoUsuarioIdEl.value = String(id || '');
            tipoAdminSenhaEl.value = '';
            tipoSelectEl.value = (tipoAtual || '').toString().trim().toLowerCase() || 'secretaria';

            const modal = window.bootstrap ? new window.bootstrap.Modal(tipoModalEl) : null;
            if (modal) modal.show();
        };

        window.openTipoModalFromBtn = function (btnEl) {
            try {
                const el = btnEl;
                const id = el && el.dataset ? el.dataset.userId : '';
                const tipo = el && el.dataset ? el.dataset.userTipo : '';
                return window.openTipoModal(id, tipo);
            } catch {
                return;
            }
        };

        if (btnSalvarTipo) {
            btnSalvarTipo.addEventListener('click', async () => {
                const uid = Number(tipoUsuarioIdEl?.value);
                const adminSenha = (tipoAdminSenhaEl?.value || '').toString();
                const tipo = (tipoSelectEl?.value || '').toString();
                if (!uid || !adminSenha || !tipo) {
                    return showAlert('danger', 'Informe a senha do admin e selecione o tipo.');
                }

                btnSalvarTipo.disabled = true;
                try {
                    const resp = await fetch(`/api/usuarios/${uid}/tipo`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                        body: JSON.stringify({ adminSenha, tipo })
                    });
                    const json = await resp.json().catch(() => ({}));
                    if (!resp.ok || !json.success) {
                        throw new Error(json.message || 'Erro ao atualizar permissão');
                    }

                    showAlert('success', 'Permissão atualizada com sucesso.');
                    try {
                        const m = window.bootstrap ? window.bootstrap.Modal.getInstance(tipoModalEl) : null;
                        if (m) m.hide();
                    } catch {}
                    setTimeout(() => window.location.reload(), 500);
                } catch (e) {
                    showAlert('danger', e.message || 'Erro ao atualizar permissão');
                } finally {
                    btnSalvarTipo.disabled = false;
                }
            });
        }

        window.toggleUsuarioAtivo = async function (id, ativo) {
            const uid = Number(id);
            const ativoNum = Number(ativo);
            if (!uid || (ativoNum !== 0 && ativoNum !== 1)) return;

            try {
                const resp = await fetch(`/api/usuarios/${uid}/ativo`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    body: JSON.stringify({ ativo: ativoNum })
                });
                const json = await resp.json().catch(() => ({}));
                if (!resp.ok || !json.success) {
                    throw new Error(json.message || 'Erro ao atualizar usuário');
                }
                showAlert('success', 'Usuário atualizado com sucesso.');
                setTimeout(() => window.location.reload(), 400);
            } catch (e) {
                showAlert('danger', e.message || 'Erro ao atualizar usuário');
            }
        };

        btn.addEventListener('click', async () => {
            const data = Object.fromEntries(new FormData(form).entries());

            if (!data.adminSenha || !data.nome || !data.email || !data.senha) {
                return showAlert('danger', 'Preencha os campos obrigatórios.');
            }
            if (data.senha !== data.confirmarSenha) {
                return showAlert('danger', 'As senhas não conferem.');
            }

            btn.disabled = true;
            try {
                const resp = await fetch('/api/usuarios', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        adminSenha: data.adminSenha,
                        nome: data.nome,
                        email: data.email,
                        senha: data.senha,
                        tipo: data.tipo,
                        cpf: data.cpf || null,
                        telefone: data.telefone || null
                    })
                });
                const json = await resp.json().catch(() => ({}));
                if (!resp.ok || !json.success) {
                    throw new Error(json.message || 'Erro ao cadastrar usuário');
                }

                showAlert('success', 'Usuário cadastrado com sucesso.');
                form.reset();
                try {
                    const modal = window.bootstrap ? window.bootstrap.Modal.getInstance(modalEl) : null;
                    if (modal) modal.hide();
                } catch (e) {
                    // ignore
                }
                setTimeout(() => window.location.reload(), 600);
            } catch (e) {
                showAlert('danger', e.message || 'Erro ao cadastrar usuário');
            } finally {
                btn.disabled = false;
            }
        });
    })();
</script>
